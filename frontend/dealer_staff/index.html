<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEALER STAFF - EVDMS</title>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">EVDMS</div>
            <nav class="menu" id="menuNav">
                <!-- Menu will be populated by JavaScript -->
            </nav>
            <div class="user-info">
                <div class="user-avatar"></div>
                <div class="user-details">
                    <div class="user-name" id="userName">Loading...</div>
                    <div class="user-role" id="userRole">DEALER_STAFF</div>
                </div>
                <button class="btn-logout" onclick="logout()">ƒêƒÉng xu·∫•t</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <h1 id="pageTitle">Dashboard Nh√¢n vi√™n</h1>
                <div class="header-actions">
                    <span id="userGreeting">Xin ch√†o!</span>
                </div>
            </header>

            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section active">
                <h2>Dashboard Nh√¢n vi√™n ƒê·∫°i l√Ω</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-info">
                            <h3>Xe c√≥ s·∫µn</h3>
                            <p class="stat-number" id="totalVehicles">...</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-info">
                            <h3>Kh√°ch h√†ng c·ªßa t√¥i</h3>
                            <p class="stat-number" id="totalCustomers">...</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-info">
                            <h3>L√°i th·ª≠ h√¥m nay</h3>
                            <p class="stat-number" id="totalTestDrives">...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Vehicles Section (Read Only) -->
            <section id="vehicles" class="content-section">
                <h2>Danh s√°ch Xe</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>T√™n xe</th>
                                <th>Phi√™n b·∫£n</th>
                                <th>M√†u</th>
                                <th>Gi√°</th>
                                <th>Tr·∫°ng th√°i</th>
                            </tr>
                        </thead>
                        <tbody id="vehiclesList"></tbody>
                    </table>
                </div>
            </section>

            <!-- Vehicle Comparison Section -->
            <section id="vehiclecomparison" class="content-section">
                <!-- Content will be loaded dynamically by vehiclecomparison.js -->
            </section>

            <!-- Customers Section -->
            <section id="customers" class="content-section">
                <h2>Qu·∫£n l√Ω Kh√°ch h√†ng</h2>
                <button class="btn btn-add" onclick="showCustomerForm()">+ Th√™m kh√°ch h√†ng</button>
                
                <div id="customerForm" class="form-container" style="display: none;">
                    <h3 id="customerFormTitle">Th√™m kh√°ch h√†ng m·ªõi</h3>
                    <form id="customerFormElement">
                        <input type="hidden" id="customerId">
                        <div class="form-group">
                            <label>H·ªç t√™n:</label>
                            <input type="text" id="customerFullName" required>
                        </div>
                        <div class="form-group">
                            <label>S·ªë ƒëi·ªán tho·∫°i:</label>
                            <input type="tel" id="customerPhone" required>
                        </div>
                        <div class="form-group">
                            <label>Email:</label>
                            <input type="email" id="customerEmail" required>
                        </div>
                        <div class="form-group">
                            <label>ƒê·ªãa ch·ªâ:</label>
                            <textarea id="customerAddress"></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">L∆∞u</button>
                            <button type="button" class="btn btn-secondary" onclick="resetCustomerForm()">H·ªßy</button>
                        </div>
                    </form>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>H·ªç t√™n</th>
                                <th>S·ªë ƒëi·ªán tho·∫°i</th>
                                <th>Email</th>
                                <th>ƒê·ªãa ch·ªâ</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="customersList"></tbody>
                    </table>
                </div>
            </section>

            <!-- Test Drives Section -->
            <section id="testdrives" class="content-section">
                <h2>Qu·∫£n l√Ω L√°i th·ª≠</h2>
                <button class="btn btn-add" onclick="showTestDriveForm()">+ ƒêƒÉng k√Ω l√°i th·ª≠</button>
                
                <div id="testDriveForm" class="form-container" style="display: none;">
                    <h3>ƒêƒÉng k√Ω l√°i th·ª≠</h3>
                    <form id="testDriveFormElement">
                        <input type="hidden" id="testDriveId">
                        <div class="form-group">
                            <label>Kh√°ch h√†ng:</label>
                            <select id="testDriveCustomer" required></select>
                        </div>
                        <div class="form-group">
                            <label>Xe:</label>
                            <select id="testDriveVehicle" required></select>
                        </div>
                        <div class="form-group">
                            <label>Ng√†y l√°i th·ª≠:</label>
                            <input type="datetime-local" id="testDriveDate" required>
                        </div>
                        <div class="form-group">
                            <label>Ghi ch√∫:</label>
                            <textarea id="testDriveNotes"></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">L∆∞u</button>
                            <button type="button" class="btn btn-secondary" onclick="resetTestDriveForm()">H·ªßy</button>
                        </div>
                    </form>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Kh√°ch h√†ng</th>
                                <th>Xe</th>
                                <th>Ng√†y l√°i th·ª≠</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="testDrivesList"></tbody>
                    </table>
                </div>
            </section>

        </main>
    </div>

    <script type="module">
        import { checkAuth, getCurrentUser, getUserRole, clearAuth } from '../assets/js/auth.js';
        import { loadVehicles } from '../assets/js/vehicles.js';
        import { loadCustomers, displayCustomers, editCustomer, saveCustomer, resetCustomerForm } from '../assets/js/customers.js';
        import { loadTestDrives, displayTestDrives, editTestDrive, saveTestDrive, resetTestDriveForm } from '../assets/js/testdrives.js';

        // Check authentication
        if (!checkAuth()) {
            window.location.href = '../login.html';
        }

        // Verify role
        const role = getUserRole();
        if (role !== 'DEALER_STAFF') {
            alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y!');
            window.location.href = '../login.html';
        }

        // Initialize menu
        const menu = [
            { id: 'dashboard', label: 'Dashboard', icon: 'üìä' },
            { id: 'vehicles', label: 'Danh s√°ch Xe', icon: 'üöó' },
            { id: 'vehiclecomparison', label: 'So s√°nh Xe', icon: '‚öñÔ∏è' },
            { id: 'customers', label: 'Kh√°ch h√†ng', icon: 'üë•' },
            { id: 'testdrives', label: 'L√°i th·ª≠', icon: 'üèÅ' }
        ];

        const menuNav = document.getElementById('menuNav');
        menu.forEach(item => {
            const link = document.createElement('a');
            link.href = '#';
            link.className = 'menu-item';
            link.innerHTML = `<span class="menu-icon">${item.icon}</span><span class="menu-label">${item.label}</span>`;
            link.onclick = (e) => {
                e.preventDefault();
                showPage(item.id);
            };
            menuNav.appendChild(link);
        });

        // Show page function
        async function showPage(pageId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
            document.getElementById('pageTitle').textContent = menu.find(m => m.id === pageId)?.label || 'Dashboard';
            
            // Load vehicle comparison module dynamically
            if (pageId === 'vehiclecomparison') {
                const container = document.getElementById('vehiclecomparison');
                const { init } = await import('../js/modules/vehiclecomparison.js');
                await init(container);
            }
        }

        // User info
        const user = getCurrentUser();
        document.getElementById('userName').textContent = user?.fullName || user?.username || 'User';
        document.getElementById('userGreeting').textContent = `Xin ch√†o, ${user?.fullName || user?.username}!`;

        // Logout function
        window.logout = function() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                clearAuth();
                window.location.href = '../login.html';
            }
        };

        // Expose functions to global scope
        window.showCustomerForm = () => document.getElementById('customerForm').style.display = 'block';
        window.resetCustomerForm = resetCustomerForm;
        window.editCustomer = editCustomer;
        window.saveCustomer = saveCustomer;
        
        window.showTestDriveForm = () => document.getElementById('testDriveForm').style.display = 'block';
        window.resetTestDriveForm = resetTestDriveForm;
        window.editTestDrive = editTestDrive;
        window.saveTestDrive = saveTestDrive;

        // Form submissions
        document.getElementById('customerFormElement').addEventListener('submit', (e) => {
            e.preventDefault();
            saveCustomer();
        });

        document.getElementById('testDriveFormElement').addEventListener('submit', (e) => {
            e.preventDefault();
            saveTestDrive();
        });

        // Load initial data
        async function init() {
            await loadVehicles();
            await loadCustomers();
            await loadTestDrives();
            updateDashboardStats();
        }

        function updateDashboardStats() {
            // Update stats from loaded data
            document.getElementById('totalVehicles').textContent = document.querySelectorAll('#vehiclesList tr').length;
            document.getElementById('totalCustomers').textContent = document.querySelectorAll('#customersList tr').length;
            document.getElementById('totalTestDrives').textContent = document.querySelectorAll('#testDrivesList tr').length;
        }

        init();
    </script>
</body>
</html>

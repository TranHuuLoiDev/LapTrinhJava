<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEALER MANAGER - EVDMS</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">EVDMS</div>
            <nav class="menu" id="menuNav">
                <!-- Menu will be populated by JavaScript -->
            </nav>
            <div class="user-info">
                <div class="user-avatar"></div>
                <div class="user-details">
                    <div class="user-name" id="userName">Loading...</div>
                    <div class="user-role" id="userRole">DEALER_MANAGER</div>
                </div>
                <button class="btn-logout" onclick="logout()">ƒêƒÉng xu·∫•t</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <h1 id="pageTitle">Dashboard Qu·∫£n l√Ω</h1>
                <div class="header-actions">
                    <span id="userGreeting">Xin ch√†o!</span>
                </div>
            </header>

            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section active">
                <h2>Dashboard Qu·∫£n l√Ω ƒê·∫°i l√Ω</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-info">
                            <h3>Xe c√≥ s·∫µn</h3>
                            <p class="stat-number" id="totalVehicles">...</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-info">
                            <h3>Kh√°ch h√†ng</h3>
                            <p class="stat-number" id="totalCustomers">...</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-info">
                            <h3>ƒê∆°n h√†ng</h3>
                            <p class="stat-number" id="totalOrders">...</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-info">
                            <h3>Ph·∫£n h·ªìi</h3>
                            <p class="stat-number" id="totalFeedbacks">...</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-info">
                            <h3>L√°i th·ª≠</h3>
                            <p class="stat-number" id="totalTestDrives">...</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-info">
                            <h3>T√†i ch√≠nh</h3>
                            <p class="stat-number" id="totalFinancing">...</p>
                        </div>
                    </div>
                </div>
                
                <div class="charts-grid" style="margin-top: 30px;">
                    <div class="chart-card">
                        <h3>Doanh s·ªë theo th√°ng</h3>
                        <canvas id="salesChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Tr·∫°ng th√°i ƒë∆°n h√†ng</h3>
                        <canvas id="orderStatusChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Vehicles Section (Read Only) -->
            <section id="vehicles" class="content-section">
                <h2>Danh s√°ch Xe</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>T√™n xe</th>
                                <th>Phi√™n b·∫£n</th>
                                <th>M√†u</th>
                                <th>Gi√° b√°n</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="vehiclesList"></tbody>
                    </table>
                </div>
            </section>

            <!-- Customers Section -->
            <section id="customers" class="content-section">
                <h2>Qu·∫£n l√Ω Kh√°ch h√†ng</h2>
                <button class="btn btn-add" onclick="showCustomerForm()">+ Th√™m kh√°ch h√†ng</button>
                
                <div id="customerForm" class="form-container" style="display: none;"></div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>H·ªç t√™n</th>
                                <th>S·ªë ƒëi·ªán tho·∫°i</th>
                                <th>Email</th>
                                <th>ƒê·ªãa ch·ªâ</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="customersList"></tbody>
                    </table>
                </div>
            </section>

            <!-- Orders Section -->
            <section id="orders" class="content-section">
                <h2>Qu·∫£n l√Ω ƒê∆°n h√†ng</h2>
                <button class="btn btn-add" onclick="showOrderForm()">+ T·∫°o ƒë∆°n h√†ng</button>
                
                <div id="orderForm" class="form-container" style="display: none;"></div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Kh√°ch h√†ng</th>
                                <th>Ng√†y ƒë·∫∑t</th>
                                <th>T·ªïng ti·ªÅn</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="ordersList"></tbody>
                    </table>
                </div>
            </section>

            <!-- Financing Section -->
            <section id="financing" class="content-section">
                <h2>Qu·∫£n l√Ω T√†i ch√≠nh Kh√°ch h√†ng</h2>
                <button class="btn btn-add" onclick="showFinancingForm()">+ T·∫°o h·ªì s∆° t√†i ch√≠nh</button>
                
                <div id="financingForm" class="form-container" style="display: none;"></div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Kh√°ch h√†ng</th>
                                <th>Ng√¢n h√†ng</th>
                                <th>S·ªë ti·ªÅn vay</th>
                                <th>Tr·∫£ g√≥p/th√°ng</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="financingList"></tbody>
                    </table>
                </div>
            </section>

            <!-- Test Drives Section -->
            <section id="testdrives" class="content-section">
                <h2>Qu·∫£n l√Ω L√°i th·ª≠</h2>
                <button class="btn btn-add" onclick="showTestDriveForm()">+ ƒêƒÉng k√Ω l√°i th·ª≠</button>
                
                <div id="testDriveForm" class="form-container" style="display: none;"></div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Kh√°ch h√†ng</th>
                                <th>Xe</th>
                                <th>Ng√†y l√°i th·ª≠</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="testDrivesList"></tbody>
                    </table>
                </div>
            </section>

            <!-- Feedbacks Section -->
            <section id="feedbacks" class="content-section">
                <h2>Ph·∫£n h·ªìi Kh√°ch h√†ng</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Kh√°ch h√†ng</th>
                                <th>Xe</th>
                                <th>Rating</th>
                                <th>N·ªôi dung</th>
                                <th>Ng√†y</th>
                            </tr>
                        </thead>
                        <tbody id="feedbacksList"></tbody>
                    </table>
                </div>
            </section>

            <!-- Interactions Section -->
            <section id="interactions" class="content-section">
                <h2>T∆∞∆°ng t√°c Kh√°ch h√†ng (CRM)</h2>
                <button class="btn btn-add" onclick="showInteractionForm()">+ Ghi nh·∫≠n t∆∞∆°ng t√°c</button>
                
                <div id="interactionForm" class="form-container" style="display: none;"></div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Kh√°ch h√†ng</th>
                                <th>Lo·∫°i</th>
                                <th>Ch·ªß ƒë·ªÅ</th>
                                <th>Ng√†y</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="interactionsList"></tbody>
                    </table>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="reports" class="content-section">
                <h2>B√°o c√°o & Th·ªëng k√™</h2>
                <div class="reports-grid">
                    <div class="report-card">
                        <h3> B√°o c√°o doanh s·ªë</h3>
                        <p>Doanh s·ªë theo th√°ng, qu√Ω, nƒÉm</p>
                        <button class="btn btn-primary">Xem b√°o c√°o</button>
                    </div>
                    <div class="report-card">
                        <h3> Ph√¢n t√≠ch kh√°ch h√†ng</h3>
                        <p>Ph√¢n kh√∫c v√† h√†nh vi kh√°ch h√†ng</p>
                        <button class="btn btn-primary">Xem b√°o c√°o</button>
                    </div>
                    <div class="report-card">
                        <h3> Hi·ªáu su·∫•t s·∫£n ph·∫©m</h3>
                        <p>Xe b√°n ch·∫°y, t·ªìn kho</p>
                        <button class="btn btn-primary">Xem b√°o c√°o</button>
                    </div>
                    <div class="report-card">
                        <h3> T√†i ch√≠nh</h3>
                        <p>Doanh thu, l·ª£i nhu·∫≠n, n·ª£</p>
                        <button class="btn btn-primary">Xem b√°o c√°o</button>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <script type="module">
        import { checkAuth, getCurrentUser, getUserRole, clearAuth } from '../assets/js/auth.js';
        import { loadVehicles } from '../assets/js/vehicles.js';
        import { loadCustomers } from '../assets/js/customers.js';
        import { loadOrders } from '../assets/js/Salesorders.js';
        import { loadTestDrives } from '../assets/js/testdrives.js';
        import { loadFeedbacks } from '../assets/js/feedbacks.js';
        import { loadFinancing } from '../assets/js/financing.js';
        import { loadInteractions } from '../assets/js/interactions.js';

        // Check authentication
        if (!checkAuth()) {
            window.location.href = '../login.html';
        }

        // Verify role
        const role = getUserRole();
        if (role !== 'DEALER_MANAGER') {
            alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y!');
            window.location.href = '../login.html';
        }

        // Initialize menu
        const menu = [
            { id: 'dashboard', label: 'Dashboard', icon: 'üìä' },
            { id: 'vehicles', label: 'Danh s√°ch Xe', icon: 'üöó' },
            { id: 'vehiclecomparison', label: 'So s√°nh Xe', icon: '‚öñÔ∏è' },
            { id: 'customers', label: 'Kh√°ch h√†ng', icon: 'üë•' },
            { id: 'orders', label: 'ƒê∆°n h√†ng', icon: 'üìã' },
            { id: 'testdrives', label: 'L√°i th·ª≠', icon: 'üèÅ' },
            { id: 'feedbacks', label: 'Ph·∫£n h·ªìi', icon: 'üí¨' },
            { id: 'reports', label: 'B√°o c√°o', icon: 'üìà' }
        ];

        const menuNav = document.getElementById('menuNav');
        menu.forEach(item => {
            const link = document.createElement('a');
            link.href = '#';
            link.className = 'menu-item';
            link.innerHTML = `<span class="menu-icon">${item.icon}</span><span class="menu-label">${item.label}</span>`;
            link.onclick = (e) => {
                e.preventDefault();
                showPage(item.id);
            };
            menuNav.appendChild(link);
        });

        // Show page function
        window.showPage = async function(pageId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
            document.getElementById('pageTitle').textContent = menu.find(m => m.id === pageId)?.label || 'Dashboard';
            
            // Load vehicle comparison module dynamically
            if (pageId === 'vehiclecomparison') {
                const container = document.getElementById('vehiclecomparison');
                const { init } = await import('../js/modules/vehiclecomparison.js');
                await init(container);
            }
        };

        // User info
        const user = getCurrentUser();
        document.getElementById('userName').textContent = user?.fullName || user?.username || 'Manager';
        document.getElementById('userGreeting').textContent = `Xin ch√†o, ${user?.fullName || user?.username}!`;

        // Logout function
        window.logout = function() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                clearAuth();
                window.location.href = '../login.html';
            }
        };

        // Expose form functions (will be implemented by imported modules)
        window.showCustomerForm = () => console.log('Show customer form');
        window.showVehicleForm = () => console.log('Show vehicle form');
        window.showOrderForm = () => console.log('Show order form');
        window.showTestDriveForm = () => console.log('Show test drive form');

        // Load initial data
        async function init() {
            await Promise.all([
                loadVehicles(),
                loadCustomers(),
                loadOrders(),
                loadTestDrives(),
                loadFeedbacks()
            ]);
            updateDashboardStats();
            initCharts();
        }

        function updateDashboardStats() {
            document.getElementById('totalVehicles').textContent = document.querySelectorAll('#vehiclesList tr').length;
            document.getElementById('totalCustomers').textContent = document.querySelectorAll('#customersList tr').length;
            document.getElementById('totalOrders').textContent = document.querySelectorAll('#ordersList tr').length;
            document.getElementById('totalFeedbacks').textContent = document.querySelectorAll('#feedbacksList tr').length;
            document.getElementById('totalTestDrives').textContent = document.querySelectorAll('#testDrivesList tr').length;
        }

        function initCharts() {
            // Sales Chart
            const salesCtx = document.getElementById('salesChart');
            if (salesCtx) {
                new Chart(salesCtx, {
                    type: 'line',
                    data: {
                        labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6'],
                        datasets: [{
                            label: 'Doanh s·ªë (tri·ªáu VNƒê)',
                            data: [120, 190, 300, 500, 200, 300],
                            borderColor: '#667eea',
                            tension: 0.4
                        }]
                    }
                });
            }

            // Order Status Chart
            const orderCtx = document.getElementById('orderStatusChart');
            if (orderCtx) {
                new Chart(orderCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Pending', 'Confirmed', 'Delivered', 'Cancelled'],
                        datasets: [{
                            data: [12, 19, 30, 5],
                            backgroundColor: ['#ffc107', '#28a745', '#17a2b8', '#dc3545']
                        }]
                    }
                });
            }
        }

        init();
    </script>
</body>
</html>
